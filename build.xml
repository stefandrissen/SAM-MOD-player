<?xml version="1.0" encoding="UTF-8"?>
<project name="sam-mod-player" xmlns:if="ant:if">

	<property name="python" location="../../AppData/Local/Programs/Python/Python38/python.exe" />
	<property name="pyz80" value="../pyz80/pyz80.py" />
	<property name="simcoupe" location="C:\Program Files (x86)\SimCoupe\SimCoupe.exe" />
	<property name="mapfile" value="true" />

	<!-- assemble -->

	<macrodef name="assemble">
		<attribute name="source" />
		<attribute name="obj" default="@{source}" />
		<attribute name="mapfile" default="false" />
		<attribute name="debug" default="false" />

		<sequential>

			<echo message="compiling: @{source} mapfile:@{mapfile}" />

			<mkdir dir="obj" />

			<exec executable="${python}" failonerror="true">
				<arg value="${pyz80}" />
				<arg value="--obj=obj/@{obj}" />
				<arg value="--mapfile=obj/@{source}.map" if:true="@{mapfile}" />
				<arg line="-D debug" if:true="@{debug}" />
				<arg value="src/@{source}.s" />
			</exec>

		</sequential>

	</macrodef>

	<target name="assemble-loader">

		<assemble source="loader" mapfile="${mapfile}" />

	</target>

	<target name="assemble-demo">

		<assemble source="demo" mapfile="${mapfile}" />

	</target>

	<target name="assemble-burstplayer">

		<assemble source="burstplayer" mapfile="${mapfile}" debug="true" />

	</target>

	<target name="assemble-sequencer">

		<assemble source="sequencer" mapfile="${mapfile}" />

	</target>

	<target name="assemble-example">

		<assemble source="example" />

	</target>

	<!-- create-disk -->

	<target name="create-disk" depends="assemble-loader,assemble-demo,assemble-burstplayer,assemble-sequencer,assemble-test-mod">

		<exec executable="${python}" failonerror="true">
			<arg file="${pyz80}" />
			<!-- <arg line="-I res/B-DOS15a" /> -->
			<!-- <arg line="-I res/AL-BDOS15a" /> -->
			<arg line="-I res/bdos15t-6" />
			<arg line="-I res/loading.$" />
			<arg line="-I obj/sequencer" />
			<arg line="-I obj/burstplayer" />
			<arg line="-I obj/loader" />
			<arg line="-I obj/demo" />
			<arg line="-I res/test.m" />
			<arg line="-o obj/modplayer.dsk" />
			<arg value="--mapfile=obj/boot.map" if:true="${mapfile}" />
			<arg value="src/boot.s" />
		</exec>

		<!-- adjust to what needs debugging -->
		<copy file="obj/burstplayer.map" tofile="obj/modplayer.map" if:true="${mapfile}" />

	</target>

	<!-- simcoupe -->

	<macrodef name="simcoupe">
		<attribute name="disk" />

		<sequential>

			<exec executable="${simcoupe}" spawn="true">
				<arg value="obj/@{disk}.dsk" />
			</exec>

		</sequential>

	</macrodef>

	<!-- all -->

	<target name="all" description="compile all, create disk and launch" depends="create-disk">

		<simcoupe disk="modplayer" />

	</target>

	<!-- assemble-test-mod -->

	<target name="assemble-test-mod">

		<exec executable="${python}" failonerror="true">
			<arg file="${pyz80}" />
			<arg value="--obj=res/test.m" />
			<arg value="src/test.mod.s" />
		</exec>

	</target>

	<!-- create-example -->

	<target name="create-example" depends="assemble-burstplayer,assemble-sequencer">

		<exec executable="${python}" failonerror="true">
			<arg file="${pyz80}" />
			<arg line="-I res/buena vi.m" />
			<arg line="-I obj/burstplayer" />
			<arg line="-I obj/sequencer" />
			<arg line="-o obj/example.dsk" />
			<arg value="src/example.s" />
		</exec>

	</target>

	<!-- test bustplayer -->

	<target name="test-burstplayer" description="test burstplayer">

		<exec executable="${python}" failonerror="true">
			<arg file="${pyz80}" />
			<arg line="-D testing" />
			<arg value="--mapfile=obj/burstplayer.map" />
			<arg line="-o obj/burstplayer.dsk" />
			<arg value="src/burstplayer.s" />
		</exec>

		<simcoupe disk="burstplayer" />

	</target>

	<!-- clean -->

	<target name="clean" description="clean obj">

		<delete dir="obj" />
		<mkdir dir="obj" />

	</target>

</project>
